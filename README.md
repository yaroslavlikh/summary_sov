# Summary Bot

Telegram-бот для автоматического сохранения и суммаризации переписок с использованием Google Gemini API.

## Описание

Бот сохраняет все текстовые сообщения в базу данных SQLite и автоматически создает краткие содержания переписок. Поддерживает ручную суммаризацию по запросу и настраиваемое количество сообщений для анализа.

## Основные функции

- Автоматическое сохранение всех текстовых сообщений
- Автоматическая суммаризация каждые 150 сообщений
- Ручная суммаризация через команду `/summary`
- Настраиваемое количество сообщений для анализа
- Интеграция с Google Gemini API

## Установка и настройка

### Требования

- Python 3.7 или выше
- Telegram Bot Token
- Google Gemini API Key

### Шаги установки

1. Установите зависимости:
```bash
pip install pyTelegramBotAPI google-genai python-dotenv
```

2. Создайте файл `.env` в корне проекта:
```env
BOT_TOKEN=ваш_токен_telegram_бота
GEMINI_API_KEY=ваш_ключ_gemini_api
```

3. Получите необходимые токены:
   - **Telegram Bot Token**: создайте бота через [@BotFather](https://t.me/BotFather)
   - **Gemini API Key**: получите на [Google AI Studio](https://makersuite.google.com/app/apikey)

## Запуск

```bash
python main.py
```

После успешного запуска в консоли появится сообщение "Бот запущен".

## Команды

| Команда | Описание |
|---------|----------|
| `/help` | Показать справку по командам |
| `/summary [N]` | Создать краткое содержание последних N сообщений (по умолчанию 150) |

**Примеры:**
- `/summary` - суммаризация последних 150 сообщений
- `/summary 50` - суммаризация последних 50 сообщений

## Принцип работы

1. Бот перехватывает все текстовые сообщения (кроме команд)
2. Сообщения сохраняются в SQLite базу данных
3. Сообщения от бота `sglypa_tg_bot` игнорируются
4. При достижении 150 сообщений автоматически создается краткое содержание
5. Пользователь может запросить суммаризацию вручную в любой момент

## Структура проекта

```
summary_sov/
├── main.py              # Точка входа приложения
├── config.py            # Управление конфигурацией
├── handlers/
│   └── handlers.py      # Обработчики сообщений и команд
├── llm/
│   ├── gemini.py        # Интеграция с Google Gemini
│   ├── llama.py         # Альтернативная интеграция (Ollama)
│   └── prompt.py        # Шаблон промпта для LLM
├── database/
│   ├── init_db.py       # Инициализация БД
│   └── messages.sql     # SQLite база данных
├── example.env          # Шаблон переменных окружения
└── README.md            # Документация
```

## База данных

Используется SQLite база данных `database/messages.sql`:

```sql
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    user_name TEXT NOT NULL,
    message TEXT NOT NULL
);
```

База данных создается автоматически при первом запуске.

## Конфигурация

Переменные окружения в файле `.env`:

- `BOT_TOKEN` - токен Telegram бота
- `GEMINI_API_KEY` - ключ API Google Gemini

## Модели LLM

Бот использует Google Gemini API с автоматическим переключением моделей:

1. Первичная попытка: `gemini-3-flash-preview`
2. Резервная модель: `gemini-1.5-flash` (при недоступности основной)

Альтернативная поддержка Ollama доступна в файле `llm/llama.py` (требует активации).

## Формат суммаризации

Краткое содержание формируется в следующем формате:

- Заголовок `#summary`
- Список ключевых тем с дефисом
- Вложенные подпункты с отступом в 2 пробела
- Сохранение оригинального тона переписки (шутки, сарказм, мемы)

## Устранение проблем

### Бот не отвечает на сообщения

- Проверьте корректность `BOT_TOKEN` в `.env`
- Убедитесь, что бот запущен и нет ошибок в консоли
- Проверьте, что бот добавлен в чат/группу

### Ошибки при создании суммаризации

- Проверьте корректность `GEMINI_API_KEY` в `.env`
- Убедитесь в наличии доступа к Google Gemini API
- Проверьте лимиты и баланс API ключа
- Проверьте наличие сообщений в базе данных

### Проблемы с базой данных

- Убедитесь в наличии прав на запись в директорию `database/`
- Проверьте существование директории `database/`
- Убедитесь, что файл `messages.sql` не заблокирован другим процессом

## Технические детали

- **Библиотека для Telegram**: pyTelegramBotAPI (telebot)
- **База данных**: SQLite3
- **LLM API**: Google Gemini (google-genai)
- **Управление конфигурацией**: python-dotenv

## Лицензия

Проект создан в образовательных целях.

---

**Примечание**: В конце каждого краткого содержания автоматически добавляется напоминание от компании Google.
